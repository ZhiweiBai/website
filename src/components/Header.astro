---
import HeaderLink from './HeaderLink.astro'
import { IoLogoGithub } from 'react-icons/io5'
import ThemeToggle from './ThemeToggleButton'
import DropdownMenu from './DropdownMenu'
import persona from '../assets/persona.jpg'
import { getCollection } from 'astro:content'
import { Image } from 'astro:assets'

const allPosts = (await getCollection('blog')).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
)
const allTags = new Set<string>()

allPosts.map((post: any) => {
  post.data.tags && post.data.tags.map((tag: string) => allTags.add(tag))
})
---

<header
  class="fixed z-20 w-full p-2 backdrop-blur-md transition-shadow duration-300"
>
  <div class="mx-auto max-w-3xl">
    <nav class="flex items-center gap-3">
      <a href="/" class="group flex flex-auto items-center">
        <Image
          class="h-8 w-8 rounded-full"
          src={persona}
          alt="Persona"
          layout="constrained"
          priority
        />
        <h2 class="p-2 text-lg font-semibold tracking-tighter">Home</h2>
      </a>
      <div class="hidden items-center gap-6 md:flex">
        <HeaderLink href="/research">Research</HeaderLink>
        <HeaderLink href="/publications">Publications</HeaderLink>
        <HeaderLink href="https://github.com/mazhengcn" target="_blank"
          ><IoLogoGithub />Github</HeaderLink
        >
      </div>
      <div class="flex-1"></div>
      <ThemeToggle client:visible />
      <DropdownMenu client:visible tags={Array.from(allTags)} />
    </nav>
  </div>
</header>

<script>
  function updateHeaderShadow() {
    const header = document.getElementById('main-header')
    if (!header) return

    if (window.scrollY > 0) {
      header.classList.add('shadow-lg')
    } else {
      header.classList.remove('shadow-lg')
    }
  }

  // Update on scroll
  window.addEventListener('scroll', updateHeaderShadow)

  // Update on page load
  document.addEventListener('DOMContentLoaded', updateHeaderShadow)

  // Update immediately if DOM is already loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', updateHeaderShadow)
  } else {
    updateHeaderShadow()
  }
</script>
