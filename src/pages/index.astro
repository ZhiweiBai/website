---
import type { ImageMetadata } from 'astro'
import { getCollection } from 'astro:content'
import { IoMail } from 'react-icons/io5'
import BackToTopButton from '../components/BackToTopButton'
import BaseHead from '../components/BaseHead.astro'
import Body from '../components/Body.astro'
import Content from '../components/Content.astro'
import Footer from '../components/Footer.astro'
import FormattedDate from '../components/FormattedDate.astro'
import Header from '../components/Header.astro'
import LinkButton from '../components/LinkButton'
import {
  Card,
  CardContent,
  CardFooter,
  CardHeader,
  CardTitle,
} from '../components/ui/card'
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts'

const images = import.meta.glob<{ default: ImageMetadata }>(
  '/src/assets/thumbnails/*.{jpeg,jpg,png,gif}'
)

const findKeysByValue = (imgs: any, id: string) => {
  return Object.keys(imgs).filter(key => key.includes(id + '_thumbnail'))
}

const posts = (await getCollection('blog')).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
)

// Resolve all images for posts
const postsWithImages = await Promise.all(
  posts.map(async (post: any) => {
    const matchingKeys = findKeysByValue(images, post.id)
    const heroImageAsset =
      matchingKeys.length > 0 ? images[matchingKeys[0]] : null
    let heroImageSrc

    if (heroImageAsset) {
      try {
        const loadedImage = await heroImageAsset()
        heroImageSrc = loadedImage.default
      } catch (error) {
        console.error(`Error loading thumbnail for ${post.id}:`, error)
        heroImageSrc = post.data.heroImage
      }
    } else {
      heroImageSrc = post.data.heroImage
    }

    return {
      ...post,
      resolvedHeroImage: heroImageSrc,
    }
  })
)
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
  </head>
  <Body>
    <Header title={SITE_TITLE} />
    <main class="pt-[56px]">
      <!-- <Masthead /> -->
      <!-- <Content
        className="prose prose-zinc dark:prose-invert mt-15 prose-ul:list-none"
      > -->
      <Content className="prose-ul:list-none mt-15">
        <section>
          <h1 class="text-center">Deep Learning Phenomena</h1>
          <p class="indent-8">
            Deep learning has revolutionized artificial intelligence, but many
            of its behaviors remain mysterious. From emergent capabilities in
            large language models to peculiar training dynamics, we explore the
            fascinating phenomena that arise when neural networks scale. Our
            research investigates these unexpected behaviors, seeking to
            understand why deep learning works so well and what we can learn
            from its surprises.
          </p>
        </section>
        <LinkButton href="mailto:xuzhiqin1990@sjtu.edu.cn"
          ><IoMail />Contact us</LinkButton
        >
        <hr />
        <section>
          <ul class="mb-4 grid grid-cols-1 gap-6 md:grid-cols-2">
            {
              postsWithImages.map((post: any) => {
                return (
                  <li>
                    <a href={`/blog/${post.id}/`}>
                      <Card>
                        <CardHeader>
                          <CardTitle className="text-xl font-bold">
                            {post.data.title}
                          </CardTitle>
                        </CardHeader>
                        <CardContent>
                          {post.data.description && (
                            <div class="opacity-70">
                              {post.data.description}
                            </div>
                          )}
                        </CardContent>
                        <CardFooter>
                          <p class="date font-mono text-xs opacity-70">
                            <FormattedDate date={post.data.pubDate} />
                          </p>
                        </CardFooter>
                      </Card>
                    </a>
                  </li>
                )
              })
            }
          </ul>
        </section>
      </Content>
    </main>
    <BackToTopButton client:idle />
    <Footer />
  </Body>
</html>
